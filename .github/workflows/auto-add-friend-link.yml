# .github/workflows/auto-friend-link.yml
name: Auto Friend Link

on:
  issues:
    types: [opened, edited]

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract data
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          extract() {
            echo "$ISSUE_BODY" | awk -v label="### ${1}" '$0~label{getline; while(NF==0)getline; print; exit}' | sed 's/^[[:space:]]*//'
          }
          
          TITLE=$(extract "网站名称")
          LINK=$(extract "网站地址")
          DESCRIPTION=$(extract "网站描述")
          AVATAR=$(extract "头像地址")
          SHORT_NAME=$(extract "短名称")
          
          [[ -z "$TITLE" ]] && { echo "error=名称缺失" >> $GITHUB_OUTPUT; exit 1; }
          [[ -z "$LINK" ]] && { echo "error=地址缺失" >> $GITHUB_OUTPUT; exit 1; }
          [[ ! "$LINK" =~ ^https:// ]] && { echo "error=需HTTPS" >> $GITHUB_OUTPUT; exit 1; }
          [[ -z "$SHORT_NAME" ]] && { echo "error=短名称缺失" >> $GITHUB_OUTPUT; exit 1; }
          [[ ! "$SHORT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]] && { echo "error=短名称格式" >> $GITHUB_OUTPUT; exit 1; }
          [[ -f "src/content/friends/${SHORT_NAME}.yaml" ]] && { echo "error=已存在" >> $GITHUB_OUTPUT; exit 1; }
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "link=$LINK" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "short_name=$SHORT_NAME" >> $GITHUB_OUTPUT

      - name: Create file
        if: success()
        run: |
          mkdir -p src/content/friends
          cat > "src/content/friends/${{ steps.extract.outputs.short_name }}.yaml" << EOF
          title: ${{ steps.extract.outputs.title }}
          description: ${{ steps.extract.outputs.description }}
          link: ${{ steps.extract.outputs.link }}
          avatar: ${{ steps.extract.outputs.avatar }}
          issue: ${{ github.event.issue.number }}
          EOF

      - name: Create PR
        if: success()
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Add: ${{ steps.extract.outputs.title }}"
          body: |
            Closes #${{ github.event.issue.number }}
            
            | 名称 | ${{ steps.extract.outputs.title }} |
            | 地址 | ${{ steps.extract.outputs.link }} |
            | 描述 | ${{ steps.extract.outputs.description }} |
            | 头像 | ${{ steps.extract.outputs.avatar }} |
            | 短名 | ${{ steps.extract.outputs.short_name }} |
          branch: friend/${{ steps.extract.outputs.short_name }}
          commit-message: "Add friend: ${{ steps.extract.outputs.title }}"
          delete-branch: true

      - name: Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.extract.outcome }}' === 'success';
            const error = '${{ steps.extract.outputs.error }}';
            const pr = '${{ steps.cpr.outputs.pull-request-number }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: success ? `✅ PR #${pr} 已创建` : `❌ 失败: ${error}`
            });
