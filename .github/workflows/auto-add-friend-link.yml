name: Auto Add Friend Link

on:
  issues:
    types: [opened, edited, reopened, labeled]  # æ·»åŠ  labeled äº‹ä»¶
  # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

jobs:
  process-friend-link:
    # æ”¹ä¸ºå†…éƒ¨åˆ¤æ–­ï¼Œæ°¸ä¸è·³è¿‡
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ðŸ” Debug Info
        run: |
          echo "äº‹ä»¶ç±»åž‹: ${{ github.event.action }}"
          echo "Issue ç¼–å·: ${{ github.event.issue.number || github.event.inputs.issue_number }}"
          echo "æ ‡ç­¾åˆ—è¡¨: ${{ toJson(github.event.issue.labels.*.name) }}"
          echo "Issue æ ‡é¢˜: ${{ github.event.issue.title }}"
          echo "å·¥ä½œæµè¢«è§¦å‘ï¼Œæ£€æŸ¥æ¡ä»¶..."

      - name: âœ… Check if should process
        id: check
        run: |
          # æ‰‹åŠ¨è§¦å‘ç›´æŽ¥å¤„ç†
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æŸ¥æ ‡ç­¾
          LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
          if echo "$LABELS" | grep -q "friend-link"; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ° friend-link æ ‡ç­¾ï¼Œç»§ç»­å¤„ç†"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ æœªæ£€æµ‹åˆ° friend-link æ ‡ç­¾ï¼Œè·³è¿‡å¤„ç†ï¼ˆè¿™æ˜¯æ­£å¸¸è¡Œä¸ºï¼‰"
          fi

      - name: ðŸ›‘ Exit if not friend-link
        if: steps.check.outputs.should_run == 'false'
        run: exit 0  # æ­£å¸¸é€€å‡ºï¼Œä¸æŠ¥é”™

      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract data
        if: steps.check.outputs.should_run == 'true'
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "æ­£åœ¨æå–æ•°æ®..."
          echo "$ISSUE_BODY"
          
          # å…¼å®¹å¤šç§æ ¼å¼æå–
          extract_field() {
            local label="$1"
            # æ”¯æŒ ### æ ‡é¢˜ã€**åŠ ç²—**ã€- åˆ—è¡¨æ ¼å¼
            echo "$ISSUE_BODY" | grep -E "(^### ${label}|^\*\*${label}\*\*|\s*-\s*\*\*${label}\*\*)" -A 1 | tail -n 1 | sed 's/^[[:space:]]*//' | sed 's/^- //'
          }
          
          TITLE=$(extract_field "ç½‘ç«™åç§°")
          LINK=$(extract_field "ç½‘ç«™åœ°å€")
          DESCRIPTION=$(extract_field "ç½‘ç«™æè¿°")
          AVATAR=$(extract_field "å¤´åƒåœ°å€")
          SHORT_NAME=$(extract_field "çŸ­åç§°")
          
          echo "æå–ç»“æžœ:"
          echo "  åç§°: $TITLE"
          echo "  é“¾æŽ¥: $LINK"
          echo "  æè¿°: $DESCRIPTION"
          echo "  å¤´åƒ: $AVATAR"
          echo "  çŸ­å: $SHORT_NAME"
          
          # éªŒè¯
          [[ -z "$TITLE" ]] && { echo "error=ç¼ºå°‘ç½‘ç«™åç§°" >> $GITHUB_OUTPUT; exit 1; }
          [[ -z "$LINK" ]] && { echo "error=ç¼ºå°‘ç½‘ç«™åœ°å€" >> $GITHUB_OUTPUT; exit 1; }
          [[ ! "$LINK" =~ ^https:// ]] && { echo "error=å¿…é¡»ä½¿ç”¨HTTPS" >> $GITHUB_OUTPUT; exit 1; }
          [[ -z "$SHORT_NAME" ]] && { echo "error=ç¼ºå°‘çŸ­åç§°" >> $GITHUB_OUTPUT; exit 1; }
          [[ ! "$SHORT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]] && { echo "error=çŸ­åç§°æ ¼å¼é”™è¯¯" >> $GITHUB_OUTPUT; exit 1; }
          
          # å®‰å…¨è½¬ä¹‰
          safe_yaml() {
            echo "$1" | sed 's/"/\\"/g' | sed "s/'/\\'/g" | tr -d '\n\r'
          }
          
          echo "title=$(safe_yaml "$TITLE")" >> $GITHUB_OUTPUT
          echo "link=$LINK" >> $GITHUB_OUTPUT
          echo "description=$(safe_yaml "$DESCRIPTION")" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "short_name=$SHORT_NAME" >> $GITHUB_OUTPUT

      - name: Create file
        if: steps.check.outputs.should_run == 'true' && success()
        run: |
          FILE="src/content/friends/${{ steps.extract.outputs.short_name }}.yaml"
          echo "åˆ›å»ºæ–‡ä»¶: $FILE"
          cat > "$FILE" << 'EOF'
          title: "${{ steps.extract.outputs.title }}"
          description: "${{ steps.extract.outputs.description }}"
          link: "${{ steps.extract.outputs.link }}"
          avatar: "${{ steps.extract.outputs.avatar }}"
          addedAt: ${{ github.event.issue.created_at }}
          EOF
          echo "æ–‡ä»¶å†…å®¹:"
          cat "$FILE"

      - name: Create PR
        if: steps.check.outputs.should_run == 'true' && success()
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "feat: add friend link - ${{ steps.extract.outputs.title }}"
          body: |
            ## å‹é“¾ç”³è¯· #${{ github.event.issue.number }}
            
            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | ç½‘ç«™åç§° | ${{ steps.extract.outputs.title }} |
            | ç½‘ç«™åœ°å€ | ${{ steps.extract.outputs.link }} |
            | ç½‘ç«™æè¿° | ${{ steps.extract.outputs.description }} |
            | å¤´åƒåœ°å€ | ${{ steps.extract.outputs.avatar }} |
            | çŸ­åç§° | ${{ steps.extract.outputs.short_name }} |
          branch: friend-link/${{ steps.extract.outputs.short_name }}
          commit-message: "feat: add friend link - ${{ steps.extract.outputs.title }}"
          delete-branch: true

      - name: Comment result
        if: steps.check.outputs.should_run == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.cpr.outcome }}' === 'success';
            const prNumber = '${{ steps.cpr.outputs.pull-request-number }}';
            const error = '${{ steps.extract.outputs.error }}';
            
            let body = success 
              ? `âœ… **æˆåŠŸï¼** å·²åˆ›å»º PR #${prNumber}`
              : `âŒ **å¤±è´¥ï¼** ${error}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
