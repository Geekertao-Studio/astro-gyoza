# .github/workflows/auto-friend-link.yml
name: Auto Friend Link

on:
  issues:
    types: [opened, edited]

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: ðŸ” æ™ºèƒ½æ£€æµ‹æ˜¯å¦ä¸ºå‹é“¾ç”³è¯·
        id: detect
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # æ£€æµ‹æ ‡é¢˜å‰ç¼€ [å‹é“¾] æˆ– [friend-link]
          if [[ "$ISSUE_TITLE" =~ ^\[å‹é“¾\] || "$ISSUE_TITLE" =~ ^\[friend-link\] ]]; then
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°å‹é“¾æ ‡é¢˜å‰ç¼€" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # æ£€æµ‹å†…å®¹æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…å¡«å­—æ®µ
          REQUIRED=("ç½‘ç«™åç§°" "ç½‘ç«™åœ°å€" "ç½‘ç«™æè¿°" "å¤´åƒåœ°å€" "çŸ­åç§°")
          for field in "${REQUIRED[@]}"; do
            if ! echo "$ISSUE_BODY" | grep -q "### ${field}"; then
              echo "should_process=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ æœªæ£€æµ‹åˆ°å‹é“¾æ¨¡æ¿æ ¼å¼ï¼Œè·³è¿‡å¤„ç†" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
          done
          
          echo "should_process=true" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°å‹é“¾æ¨¡æ¿æ ¼å¼" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ›‘ éžå‹é“¾ç”³è¯·ï¼Œç»ˆæ­¢
        if: steps.detect.outputs.should_process == 'false'
        run: exit 0

      - name: ðŸ”§ æå–å¹¶éªŒè¯æ•°æ®
        if: steps.detect.outputs.should_process == 'true'
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          extract() {
            echo "$ISSUE_BODY" | awk -v label="### ${1}" '$0~label{getline; while(NF==0)getline; print; exit}' | sed 's/^[[:space:]]*//'
          }

          TITLE=$(extract "ç½‘ç«™åç§°")
          LINK=$(extract "ç½‘ç«™åœ°å€")
          DESCRIPTION=$(extract "ç½‘ç«™æè¿°")
          AVATAR=$(extract "å¤´åƒåœ°å€")
          SHORT_NAME=$(extract "çŸ­åç§°")

          [[ -z "$TITLE" ]] && { echo "error=åç§°ç¼ºå¤±" >> $GITHUB_OUTPUT; exit 1; }
          [[ -z "$LINK" ]] && { echo "error=åœ°å€ç¼ºå¤±" >> $GITHUB_OUTPUT; exit 1; }
          [[ ! "$LINK" =~ ^https:// ]] && { echo "error=éœ€HTTPS" >> $GITHUB_OUTPUT; exit 1; }
          [[ -z "$SHORT_NAME" ]] && { echo "error=çŸ­åç§°ç¼ºå¤±" >> $GITHUB_OUTPUT; exit 1; }
          [[ ! "$SHORT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]] && { echo "error=çŸ­åç§°æ ¼å¼" >> $GITHUB_OUTPUT; exit 1; }
          [[ -f "src/content/friends/${SHORT_NAME}.yaml" ]] && { echo "error=å·²å­˜åœ¨" >> $GITHUB_OUTPUT; exit 1; }

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "link=$LINK" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "short_name=$SHORT_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ“„ åˆ›å»ºå‹é“¾æ–‡ä»¶
        if: steps.detect.outputs.should_process == 'true' && steps.extract.outcome == 'success'
        run: |
          mkdir -p src/content/friends
          cat > "src/content/friends/${{ steps.extract.outputs.short_name }}.yaml" << EOF
          title: ${{ steps.extract.outputs.title }}
          description: ${{ steps.extract.outputs.description }}
          link: ${{ steps.extract.outputs.link }}
          avatar: ${{ steps.extract.outputs.avatar }}
          EOF

      - name: ðŸš€ åˆ›å»º Pull Request
        if: steps.detect.outputs.should_process == 'true' && steps.extract.outcome == 'success'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          title: "Add: ${{ steps.extract.outputs.title }}"
          body: |
            Closes #${{ github.event.issue.number }}
            
            | åç§° | ${{ steps.extract.outputs.title }} |
            | åœ°å€ | ${{ steps.extract.outputs.link }} |
            | æè¿° | ${{ steps.extract.outputs.description }} |
            | å¤´åƒ | ${{ steps.extract.outputs.avatar }} |
            | çŸ­å | ${{ steps.extract.outputs.short_name }} |
          branch: friend/${{ steps.extract.outputs.short_name }}
          commit-message: "Add friend: ${{ steps.extract.outputs.title }}"
          delete-branch: true

      - name: ðŸ’¬ è¯„è®ºå¤„ç†ç»“æžœ
        if: steps.detect.outputs.should_process == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.extract.outcome }}' === 'success';
            const error = '${{ steps.extract.outputs.error }}' || 'æœªçŸ¥é”™è¯¯';
            const pr = '${{ steps.cpr.outputs.pull-request-number }}';
            const body = success ? `âœ… PR #${pr} å·²åˆ›å»º` : `âŒ å¤±è´¥: ${error}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
