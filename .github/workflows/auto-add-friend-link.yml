name: Auto Add Friend Link

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  process-friend-link:
    if: contains(github.event.issue.labels.*.name, 'friend-link')  # ä¿®å¤è§¦å‘æ¡ä»¶
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract friend link data
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # æå–å‡½æ•°ï¼ˆå¤„ç†å•è¡Œ input æ ¼å¼ï¼‰
          extract_field() {
            local label="$1"
            # æ”¯æŒ ### æ ‡é¢˜æ ¼å¼å’Œ **åŠ ç²—** æ ¼å¼
            echo "$ISSUE_BODY" | grep -E "(^### ${label}|^\*\*${label}\*\*)" -A 1 | tail -n 1 | sed 's/^[[:space:]]*//'
          }
          
          # èŽ·å–åŽŸå§‹å€¼ï¼ˆåŽ»é™¤é¦–å°¾ç©ºæ ¼ï¼‰
          TITLE=$(extract_field "ç½‘ç«™åç§°")
          LINK=$(extract_field "ç½‘ç«™åœ°å€")
          DESCRIPTION=$(extract_field "ç½‘ç«™æè¿°")
          AVATAR=$(extract_field "å¤´åƒåœ°å€")
          SHORT_NAME=$(extract_field "çŸ­åç§°")
          
          # éªŒè¯å¿…å¡«å­—æ®µ
          for field in "$TITLE" "$LINK" "$DESCRIPTION" "$AVATAR" "$SHORT_NAME"; do
            if [[ -z "$field" ]]; then
              echo "error_message=âŒ æå–å¤±è´¥ï¼šè¯·ç¡®ä¿æ‰€æœ‰å¿…å¡«å­—æ®µå·²å¡«å†™" >> $GITHUB_OUTPUT
              exit 1
            fi
          done
          
          # å®‰å…¨éªŒè¯
          [[ ! "$LINK" =~ ^https:// ]] && { echo "error_message=âŒ ç½‘ç«™åœ°å€å¿…é¡»ä½¿ç”¨ HTTPS" >> $GITHUB_OUTPUT; exit 1; }
          [[ ! "$SHORT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]] && { echo "error_message=âŒ çŸ­åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿žå­—ç¬¦" >> $GITHUB_OUTPUT; exit 1; }
          [[ -e "src/content/friends/${SHORT_NAME}.yaml" ]] && { echo "error_message=âŒ çŸ­åç§° '${SHORT_NAME}' å·²å­˜åœ¨" >> $GITHUB_OUTPUT; exit 1; }
          
          # YAML å®‰å…¨è½¬ä¹‰ï¼ˆå¤„ç†å¼•å·å’Œæ¢è¡Œï¼‰
          safe_yaml() {
            echo "$1" | sed 's/"/\\"/g' | sed "s/'/\\'/g" | tr -d '\n' | tr -d '\r'
          }
          
          echo "title=$(safe_yaml "$TITLE")" >> $GITHUB_OUTPUT
          echo "link=$LINK" >> $GITHUB_OUTPUT
          echo "description=$(safe_yaml "$DESCRIPTION")" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "short_name=$SHORT_NAME" >> $GITHUB_OUTPUT

      - name: Create friend link file
        if: success()
        run: |
          mkdir -p src/content/friends
          cat > "src/content/friends/${{ steps.extract.outputs.short_name }}.yaml" << 'EOF'
          # å‹é“¾ç”³è¯· from Issue #${{ github.event.issue.number }}
          title: "${{ steps.extract.outputs.title }}"
          description: "${{ steps.extract.outputs.description }}"
          link: "${{ steps.extract.outputs.link }}"
          avatar: "${{ steps.extract.outputs.avatar }}"
          addedAt: ${{ github.event.issue.created_at }}
          EOF

      - name: Create Pull Request
        if: success()
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "feat: add friend link - ${{ steps.extract.outputs.title }}"
          body: |
            ## å‹é“¾ç”³è¯·è‡ªåŠ¨åŒ– PR
            
            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | ç½‘ç«™åç§° | ${{ steps.extract.outputs.title }} |
            | ç½‘ç«™åœ°å€ | ${{ steps.extract.outputs.link }} |
            | ç½‘ç«™æè¿° | ${{ steps.extract.outputs.description }} |
            | å¤´åƒåœ°å€ | ${{ steps.extract.outputs.avatar }} |
            | çŸ­åç§° | ${{ steps.extract.outputs.short_name }} |
            
            **å…³è” Issue**: #${{ github.event.issue.number }}
            
            ---
            ðŸ”„ è¯·å®¡æ ¸å†…å®¹æ˜¯å¦ç¬¦åˆå‹é“¾è¦æ±‚ï¼Œé€šè¿‡åŽåˆå¹¶å³å¯è‡ªåŠ¨å‘å¸ƒã€‚
          branch: friend-link/${{ steps.extract.outputs.short_name }}
          commit-message: "feat: add friend link - ${{ steps.extract.outputs.title }}"
          delete-branch: true
          labels: friend-link

      - name: Comment success on issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.cpr.outputs.pull-request-number }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **å¤„ç†æˆåŠŸï¼**\n\nå·²åˆ›å»º Pull Request #${prNumber}ï¼Œè¯·ç­‰å¾…å®¡æ ¸ã€‚`
            })

      - name: Comment failure on issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const errorMessage = '${{ steps.extract.outputs.error_message }}' || 'æœªçŸ¥é”™è¯¯';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${errorMessage}\n\nè¯·ä¿®æ”¹åŽé‡æ–°æäº¤ï¼Œæˆ–è”ç³»ç»´æŠ¤è€…ã€‚`
            })
          # å¯é€‰ï¼šè‡ªåŠ¨å…³é—­æ ¼å¼é”™è¯¯çš„ Issue
          # github.rest.issues.update({...state: 'closed'})
